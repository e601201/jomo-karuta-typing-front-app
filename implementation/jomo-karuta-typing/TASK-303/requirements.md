# TASK-303: ランダム出題モード 要件定義

## 概要

上毛かるた44枚をランダムな順序で出題するモードを実装する。練習モードとは異なり、毎回異なる順序でカードが提示されることで、飽きずに練習を続けられる機能を提供する。

## 要件詳細

### 機能要件

#### REQ-103: ランダム出題機能

1. **基本動作**
   - 44枚のカードをランダムな順序で出題する
   - 1セッション内では同じカードが重複して出題されない（重複なし保証）
   - セッションごとに異なる順序で出題される

2. **シャッフルアルゴリズム**
   - Fisher-Yates アルゴリズムを使用した均等な分布のシャッフル
   - 偏りのない完全にランダムな順序を保証

3. **セッション管理**
   - ゲーム開始時にカードデックをシャッフル
   - 途中終了・再開時も残りのカードの順序を保持
   - 完了時は全44枚を出題完了として記録

### 非機能要件

1. **パフォーマンス**
   - シャッフル処理は100ms以内に完了
   - メモリ使用量は既存の練習モードと同等レベル

2. **ユーザビリティ**
   - モード選択画面で「ランダムモード」として明示的に選択可能
   - 現在の進捗（X/44枚）を表示

3. **拡張性**
   - 将来的なシード値指定による再現性の実装を考慮した設計
   - 他のモード（時間制限付きランダムなど）への拡張が容易

## 実装範囲

### 対象ファイル

1. `src/lib/services/game/random-mode.ts` - ランダムモードサービス（新規）
2. `src/lib/services/game/random-mode.spec.ts` - テストファイル（新規）
3. `src/lib/services/game/game-manager.ts` - 既存（ランダムモード対応は実装済み）

### 実装内容

1. **RandomModeService クラス**
   - カードデックのシャッフル機能
   - 出題順序の管理
   - 重複チェック機能
   - セッション状態の保存・復元

2. **テスト項目**
   - シャッフルのランダム性検証
   - 重複なし保証の確認
   - 全カード出題の保証
   - セッション管理の動作確認

## 受け入れ基準

1. **機能面**
   - [ ] 44枚のカードがランダムな順序で出題される
   - [ ] 同一セッション内で同じカードが2回出題されない
   - [ ] 異なるセッションで異なる順序になる
   - [ ] 全44枚が出題される

2. **品質面**
   - [ ] シャッフルアルゴリズムが統計的に偏りがない
   - [ ] テストカバレッジ90%以上
   - [ ] パフォーマンス基準を満たす

3. **ユーザー体験**
   - [ ] モード選択が直感的
   - [ ] 進捗が明確に表示される
   - [ ] 途中終了・再開が正しく動作

## 制約事項

1. **技術的制約**
   - 既存のGameManagerクラスとの互換性を保つ
   - 既存のストア構造を変更しない

2. **実装上の注意**
   - Math.random()を使用（暗号学的セキュリティは不要）
   - カードデータは既存のkaruta-cards.jsonを使用

## テスト戦略

1. **単体テスト**
   - シャッフルアルゴリズムの均等性
   - 重複チェック機能
   - セッション管理

2. **統合テスト**
   - GameManagerとの連携
   - ストアとの連携

3. **統計的テスト**
   - 1000回のシャッフルで分布の偏りをチェック
   - 各位置に各カードが出現する確率の検証

## 実装優先順位

1. シャッフルアルゴリズムの実装
2. 重複なし保証の実装
3. セッション管理機能
4. テストの充実
5. パフォーマンス最適化（必要に応じて）
