# TASK-202: タイピングゲーム画面 - 要件定義

## 目的

上毛かるたのタイピング練習を実際に行うゲーム画面を実装する。
リアルタイムで入力を判定し、視覚的フィードバックを提供する。

## 機能要件

### 1. ゲームモード処理 (REQ-002, REQ-007)

- URLパラメータからゲームモードを取得
  - `practice`: 練習モード（順番に出題）
  - `specific`: 特定札練習モード
  - `random`: ランダム出題モード
- continueパラメータがある場合は前回の続きから

### 2. 札の表示 (REQ-002)

- 現在の札（読み札）を大きく表示
- ふりがな表示（設定に応じて）
- カード番号と進捗表示（例: 1/44）

### 3. タイピング入力処理 (REQ-003, REQ-004)

- キーボード入力をリアルタイムで取得
- 入力判定エンジンによる正誤判定
- 複数の入力パターンに対応
  - 例: 「し」→ "shi" または "si"
  - 例: 「つ」→ "tsu" または "tu"

### 4. リアルタイムフィードバック (REQ-107, REQ-108)

- 入力文字のハイライト表示
  - 正解: 緑色
  - 不正解: 赤色
  - 未入力: グレー
- 現在の入力位置を明示
- ローマ字表示（入力ガイド）
- 入力ミスの即座のフィードバック

### 5. 進捗管理

- プログレスバー表示
- 完了枚数/総枚数の表示
- 現在のカードの入力進捗

### 6. スコア表示

- WPM（Words Per Minute）
- 正確率
- コンボ数
- 経過時間

### 7. ゲーム制御

- 一時停止/再開機能
- 次の札へ進む（自動/手動）
- ゲーム終了処理

## UI/UX要件

### 1. レイアウト

```
┌─────────────────────────────────────┐
│  進捗: 1/44  時間: 00:32  WPM: 120  │  <- ヘッダー
├─────────────────────────────────────┤
│                                     │
│        つ る 舞 う 形 の              │  <- 読み札（大）
│        群 馬 県                     │
│                                     │
│    t s u r u m a u k a t a c h i   │  <- ローマ字ガイド
│    [===...........]                 │  <- 入力進捗
│                                     │
│    正確率: 95%  コンボ: 5           │  <- スコア
│                                     │
│    [一時停止] [スキップ] [終了]     │  <- コントロール
└─────────────────────────────────────┘
```

### 2. ローディング状態

- かるたデータ読み込み中の表示
- スケルトンスクリーンまたはスピナー

### 3. エラー状態

- データ読み込みエラー
- 不正なゲームモード

### 4. アニメーション

- 札の切り替えアニメーション
- 文字入力時のハイライトアニメーション
- 正解時のエフェクト

### 5. レスポンシブデザイン

- モバイル: 縦向き最適化
- タブレット: 横向き対応
- デスクトップ: 大画面対応

### 6. アクセシビリティ

- キーボードのみで操作可能
- スクリーンリーダー対応
- 高コントラストモード対応

## 技術要件

### 1. コンポーネント構造

```
src/routes/game/
├── +page.svelte        # メインゲーム画面
├── +page.ts           # ページロード処理
└── +page.spec.ts      # テストファイル

src/lib/components/game/
├── CardDisplay.svelte      # 札表示コンポーネント
├── InputDisplay.svelte     # 入力表示コンポーネント
├── ProgressBar.svelte      # 進捗バー
├── ScoreBoard.svelte       # スコア表示
└── GameControls.svelte     # ゲームコントロール
```

### 2. 状態管理

- ゲームストア (`$lib/stores/game.ts`) を使用
- リアクティブな状態更新
- セッション管理

### 3. 入力処理

- InputValidator (`$lib/services/typing/input-validator.ts`) を使用
- キーボードイベントのハンドリング
- IME無効化処理

### 4. データ永続化

- IndexedDBへのセッション保存
- 進捗の自動保存
- 設定の読み込み

### 5. パフォーマンス要件

- 入力反応時間: 30ms以内
- 60fps のアニメーション
- メモリ使用量の最適化

## 受け入れ基準

### 必須要件

1. [ ] ゲームモードに応じた札の出題
2. [ ] リアルタイムの入力判定
3. [ ] 視覚的フィードバック
4. [ ] 進捗の表示
5. [ ] スコアの計算と表示
6. [ ] 一時停止機能
7. [ ] ゲーム終了処理

### 品質基準

1. [ ] 入力遅延 30ms以内
2. [ ] テストカバレッジ 80%以上
3. [ ] Lighthouse スコア 90以上
4. [ ] アクセシビリティ基準準拠

## テスト戦略

### 単体テスト

- 入力処理のテスト
- スコア計算のテスト
- 状態遷移のテスト

### 統合テスト

- ゲームフロー全体
- ストアとの連携
- データ永続化

### パフォーマンステスト

- 入力レスポンス測定
- メモリリーク検証
- アニメーションFPS測定

## 実装の優先順位

1. **Phase 1: 基本機能**
   - 札の表示
   - キーボード入力取得
   - 基本的な入力判定

2. **Phase 2: フィードバック**
   - ハイライト表示
   - ローマ字ガイド
   - エラー表示

3. **Phase 3: ゲーム機能**
   - スコア計算
   - 進捗管理
   - 一時停止

4. **Phase 4: 完成度向上**
   - アニメーション
   - レスポンシブ対応
   - アクセシビリティ
