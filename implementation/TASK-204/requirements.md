# TASK-204: 部分入力モード実装 - 要件定義

## 目的

初心者や練習目的のユーザーのために、札の一部分のみを入力対象とする部分入力モードを実装する。これにより、段階的な学習を可能にし、初心者でもゲームを楽しめるようにする。

## 機能要件

### 1. 部分入力モード設定 (REQ-008, REQ-104)

- 入力対象文字数を設定可能（1文字～全文字）
- デフォルトは5文字（初心者向け）
- 設定は以下の方法で変更可能：
  - スライダーUI（1～20文字）
  - プリセット選択（初心者：5文字、中級：10文字、上級：全文字）
  - 数値直接入力

### 2. 入力対象範囲の決定 (REQ-105)

- **先頭モード**: 札の最初からN文字
- **ランダムモード**: 札内のランダムな位置からN文字
- **重要部分モード**: 札の特徴的な部分を優先（将来拡張）
- デフォルトは「先頭モード」

### 3. 視覚的フィードバック (REQ-106)

- 入力対象範囲の明確な表示
  - 対象文字: 通常表示
  - 非対象文字: グレーアウトまたは半透明
- 入力対象範囲のハイライト
- 進捗インジケーターの調整

### 4. 初心者モード統合

- 初心者モード選択時の自動設定
  - 部分入力: 5文字
  - ローマ字ガイド: 表示
  - 入力速度要求: 緩和

## 技術要件

### 1. データ構造

```typescript
interface PartialInputConfig {
	enabled: boolean; // 部分入力モードの有効/無効
	characterCount: number; // 入力対象文字数
	mode: PartialInputMode; // 範囲決定モード
	highlightRange: boolean; // 範囲ハイライトの有無
}

type PartialInputMode = 'start' | 'random' | 'important';

interface PartialInputRange {
	start: number; // 開始位置（0ベース）
	end: number; // 終了位置（含まない）
	text: string; // 対象テキスト
	fullText: string; // 全文
}
```

### 2. コンポーネント設計

#### PartialInputSettings.svelte

- 部分入力モードの設定UI
- スライダー、プリセットボタン、数値入力
- リアルタイムプレビュー

#### PartialInputProcessor.ts

- 入力対象範囲の計算
- 入力判定の調整
- 進捗計算の修正

### 3. 既存コンポーネントの修正

#### InputValidator.ts

```typescript
class InputValidator {
	// 既存のメソッドに加えて
	setPartialRange(range: PartialInputRange): void;
	validatePartialInput(input: string, position: number): ValidationResult;
	getPartialRomajiPatterns(): string[];
}
```

#### InputHighlight.svelte

```typescript
interface Props {
	// 既存のプロパティに加えて
	partialRange?: PartialInputRange;
	dimNonTarget?: boolean; // 非対象文字を薄く表示
}
```

## UI/UX要件

### 1. 設定画面

- **場所**: ゲーム設定またはゲーム画面内のオプション
- **レイアウト**:

  ```
  部分入力モード: [ON/OFF トグル]

  文字数: [====|----] 5文字

  プリセット: [初心者] [中級] [上級] [カスタム]

  範囲: (●) 先頭から ( ) ランダム

  プレビュー: つるま|うかたちの...
              ^^^^^ (入力対象)
  ```

### 2. ゲーム画面での表示

- 入力対象文字を明確に区別
- 非対象文字は視認可能だが目立たない
- 進捗バーは部分入力に対応

### 3. アニメーション

- 範囲変更時のスムーズな遷移
- ハイライトのフェードイン/アウト

## 受け入れ基準

### 必須要件

1. [ ] 部分入力モードのON/OFF切り替えが可能
2. [ ] 文字数を1～全文字で設定可能
3. [ ] 先頭からの部分入力が正しく動作
4. [ ] 入力対象範囲が視覚的に明確
5. [ ] 部分入力でも正しくスコアが計算される

### 品質基準

1. [ ] 設定変更が即座に反映される
2. [ ] パフォーマンスの劣化がない
3. [ ] アクセシビリティが保たれる
4. [ ] モバイルでも操作しやすい

## パフォーマンス目標

- 範囲計算: < 1ms
- 設定変更の反映: < 16ms
- メモリ増加: < 1MB

## テスト戦略

### 単体テスト

- 範囲計算ロジック
- 入力判定の正確性
- 設定の保存/読み込み

### 統合テスト

- ゲームフローとの統合
- 他のモードとの組み合わせ
- スコア計算の整合性

### E2Eテスト

- 設定変更からゲームプレイまでの流れ
- 異なる文字数での動作確認

## 実装の優先順位

1. 先頭モードの基本実装
2. 設定UIの実装
3. 視覚的フィードバック
4. ランダムモード
5. プリセット機能

## 将来の拡張性

- 重要部分の自動検出
- ユーザーごとの学習履歴に基づく調整
- 段階的な難易度上昇
- カスタム範囲の保存
