# TASK-103: ローカルストレージ永続化 - テストケース設計

## テストケース一覧

### 1. 初期化テスト

#### TC-001: サービス初期化

```typescript
describe('LocalStorageService - 初期化', () => {
	it('サービスが正しく初期化される', () => {
		// 期待値:
		// - ストレージが利用可能
		// - デフォルト値が設定される
		// - バージョン情報が保存される
	});

	it('ストレージが利用できない場合にフォールバックする', () => {
		// 期待値:
		// - メモリストレージへフォールバック
		// - エラーをスロー しない
	});
});
```

### 2. 設定管理テスト

#### TC-002: 設定の保存と読み込み

```typescript
describe('LocalStorageService - 設定管理', () => {
	it('設定を保存できる', () => {
		// 入力: GameSettings オブジェクト
		// 期待値:
		// - LocalStorageに保存される
		// - 正しいキーで保存される
	});

	it('設定を読み込める', () => {
		// 期待値:
		// - 保存した設定が復元される
		// - デフォルト値とマージされる
	});

	it('部分的な設定更新ができる', () => {
		// 入力: Partial<GameSettings>
		// 期待値:
		// - 指定した部分のみ更新
		// - 他の設定は保持される
	});

	it('設定をリセットできる', () => {
		// 期待値:
		// - デフォルト値に戻る
		// - LocalStorageから削除される
	});
});
```

### 3. プロファイル管理テスト

#### TC-003: ユーザープロファイル

```typescript
describe('LocalStorageService - プロファイル管理', () => {
	it('プロファイルを保存できる', () => {
		// 入力: UserProfile
		// 期待値:
		// - プロファイル情報が保存される
		// - タイムスタンプが更新される
	});

	it('プロファイルが存在しない場合はnullを返す', () => {
		// 期待値: null
	});

	it('プレイ時間が累積される', () => {
		// 期待値:
		// - totalPlayTimeが増加
		// - lastPlayedAtが更新
	});
});
```

### 4. 進捗管理テスト

#### TC-004: ゲーム進捗

```typescript
describe('LocalStorageService - 進捗管理', () => {
	it('完了した札を追加できる', () => {
		// 入力: カードID
		// 期待値:
		// - completedCardsに追加
		// - 重複は追加されない
	});

	it('ベストスコアを更新できる', () => {
		// 入力: mode, scoreData
		// 期待値:
		// - より高いスコアの場合のみ更新
		// - 日付が記録される
	});

	it('アチーブメントを記録できる', () => {
		// 入力: achievementId
		// 期待値:
		// - achievementsに追加
		// - unlockedAtが記録
	});
});
```

### 5. セッション管理テスト

#### TC-005: セッション保存と復元

```typescript
describe('LocalStorageService - セッション管理', () => {
	it('ゲームセッションを保存できる', () => {
		// 入力: GameState
		// 期待値:
		// - セッション情報が保存される
		// - 必要なデータのみ保存される
	});

	it('セッションを復元できる', () => {
		// 期待値:
		// - 保存したセッションが復元される
		// - 無効なセッションはnullを返す
	});

	it('セッションをクリアできる', () => {
		// 期待値:
		// - LocalStorageから削除される
		// - hasSession()がfalseを返す
	});

	it('セッションの有無を確認できる', () => {
		// 期待値:
		// - セッションがある場合true
		// - ない場合false
	});
});
```

### 6. 統計管理テスト

#### TC-006: 統計データ

```typescript
describe('LocalStorageService - 統計管理', () => {
	it('統計データを更新できる', () => {
		// 入力: Partial<GameStatistics>
		// 期待値:
		// - 指定したフィールドが更新
		// - 累積値が正しく計算される
	});

	it('カード別統計を更新できる', () => {
		// 入力: cardId, cardStatData
		// 期待値:
		// - 該当カードの統計が更新
		// - 平均値が再計算される
	});

	it('統計データを初期化できる', () => {
		// 期待値:
		// - すべての統計が0にリセット
		// - cardStatsが空になる
	});
});
```

### 7. データ管理テスト

#### TC-007: インポート/エクスポート

```typescript
describe('LocalStorageService - データ管理', () => {
	it('データをエクスポートできる', () => {
		// 期待値:
		// - JSON文字列として出力
		// - Base64エンコードされる
		// - すべてのデータが含まれる
	});

	it('データをインポートできる', () => {
		// 入力: エクスポートされたデータ
		// 期待値:
		// - データが復元される
		// - バージョン互換性チェック
		// - 不正データは拒否される
	});

	it('すべてのデータをクリアできる', () => {
		// 期待値:
		// - LocalStorageが空になる
		// - 確認なしでは実行されない
	});

	it('ストレージサイズを取得できる', () => {
		// 期待値:
		// - バイト単位のサイズ
		// - 各キーのサイズも取得可能
	});
});
```

### 8. エラーハンドリングテスト

#### TC-008: エラー処理

```typescript
describe('LocalStorageService - エラーハンドリング', () => {
	it('容量超過エラーを処理できる', () => {
		// シナリオ: QuotaExceededError
		// 期待値:
		// - エラーをキャッチ
		// - 古いデータを削除して再試行
		// - それでも失敗したらエラー
	});

	it('破損データを検出できる', () => {
		// シナリオ: 不正なJSON
		// 期待値:
		// - パースエラーをキャッチ
		// - デフォルト値を返す
		// - 破損データを削除
	});

	it('プライベートモードで動作する', () => {
		// 期待値:
		// - メモリストレージを使用
		// - エラーをスローしない
	});

	it('セキュリティエラーを処理できる', () => {
		// シナリオ: SecurityError
		// 期待値:
		// - フォールバック動作
		// - ユーザーに通知
	});
});
```

### 9. データマイグレーションテスト

#### TC-009: バージョン管理

```typescript
describe('LocalStorageService - マイグレーション', () => {
	it('古いバージョンからマイグレーションできる', () => {
		// 入力: v1データ
		// 期待値:
		// - v2形式に変換される
		// - データの欠損なし
	});

	it('不明なバージョンを処理できる', () => {
		// 期待値:
		// - データをクリア
		// - 新規初期化
	});

	it('マイグレーション失敗時にロールバックする', () => {
		// 期待値:
		// - 元のデータが保持される
		// - エラーログ出力
	});
});
```

### 10. パフォーマンステスト

#### TC-010: パフォーマンス

```typescript
describe('LocalStorageService - パフォーマンス', () => {
	it('初期化が100ms以内に完了する', () => {
		// 計測: initialize()の実行時間
	});

	it('データ読み込みが50ms以内に完了する', () => {
		// 計測: 各get系メソッド
	});

	it('データ保存が30ms以内に完了する', () => {
		// 計測: 各save系メソッド
	});

	it('大量データでもメモリリークしない', () => {
		// シナリオ: 1000回の読み書き
		// 期待値: メモリ使用量が安定
	});
});
```

### 11. 統合テスト

#### TC-011: ゲームストアとの統合

```typescript
describe('LocalStorageService - 統合', () => {
	it('ゲーム終了時に自動保存される', () => {
		// 期待値:
		// - endSession時に保存
		// - 必要なデータが永続化
	});

	it('アプリ起動時に自動復元される', () => {
		// 期待値:
		// - 設定が復元される
		// - セッションが再開可能
	});

	it('ページ離脱時に保存される', () => {
		// イベント: beforeunload
		// 期待値: 現在の状態が保存
	});
});
```

## モックデータ

```typescript
// テスト用設定
const mockSettings: GameSettings = {
	display: {
		theme: 'dark',
		fontSize: 'medium',
		showFurigana: true
	},
	sound: {
		enabled: true,
		volume: 50,
		effectsEnabled: true
	},
	game: {
		defaultMode: 'practice',
		partialInputLength: 5,
		showHints: false
	}
};

// テスト用プロファイル
const mockProfile: UserProfile = {
	nickname: 'テストユーザー',
	createdAt: '2024-01-01T00:00:00Z',
	lastPlayedAt: '2024-01-02T10:00:00Z',
	totalPlayTime: 3600000
};

// テスト用セッション
const mockSession: SavedSession = {
	id: 'session-123',
	mode: 'practice',
	startTime: '2024-01-02T10:00:00Z',
	cards: {
		current: { id: 'tsu' /* ... */ },
		currentIndex: 5,
		remaining: [],
		completed: []
	},
	score: {
		total: 1000,
		accuracy: 95.5,
		speed: 120,
		combo: 3,
		maxCombo: 10
	},
	timer: {
		elapsedTime: 180000,
		pausedDuration: 5000
	}
};

// LocalStorageモック
const localStorageMock = {
	getItem: jest.fn(),
	setItem: jest.fn(),
	removeItem: jest.fn(),
	clear: jest.fn(),
	length: 0,
	key: jest.fn()
};
```

## テスト実装順序

1. **Phase 1: 基本機能**
   - TC-001: 初期化
   - TC-002: 設定管理
   - TC-007: データ管理

2. **Phase 2: データ永続化**
   - TC-003: プロファイル管理
   - TC-004: 進捗管理
   - TC-005: セッション管理
   - TC-006: 統計管理

3. **Phase 3: 高度な機能**
   - TC-008: エラーハンドリング
   - TC-009: マイグレーション

4. **Phase 4: 品質保証**
   - TC-010: パフォーマンス
   - TC-011: 統合テスト

## カバレッジ目標

- ライン: 90%以上
- ブランチ: 85%以上
- 関数: 95%以上
- ステートメント: 90%以上
