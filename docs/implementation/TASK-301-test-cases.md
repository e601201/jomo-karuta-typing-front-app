# TASK-301: 練習モード - テストケース設計書

## 概要

練習モード機能の包括的なテストケースを定義する。順番出題、セッション管理、統計記録の各機能を網羅的にテストする。

## テストスイート構造

### 1. 練習モード初期化テスト

**スイート名**: `練習モード - 初期化`

#### Test Case 1.1: URLパラメータ解析

- **目的**: mode=practiceパラメータが正しく認識される
- **テスト内容**:
  - URL: `/game?mode=practice`でアクセス
  - ゲームモードの確認
- **期待結果**: モードが'practice'として初期化

#### Test Case 1.2: 札データの読み込み

- **目的**: 44枚の札が正しい順序で読み込まれる
- **テスト内容**:
  - getKarutaCards()の呼び出し確認
  - 札の順序確認（あ→わ）
- **期待結果**: 44枚が正しい順序で配列に格納

#### Test Case 1.3: 初期状態の設定

- **目的**: ゲーム開始時の状態が正しく設定される
- **テスト内容**:
  - currentCardIndex: 0
  - completedCards: []
  - 統計情報の初期値
- **期待結果**: すべての初期値が正しく設定

### 2. 出題ロジックテスト

**スイート名**: `練習モード - 出題ロジック`

#### Test Case 2.1: 順番出題

- **目的**: 札が正しい順序で出題される
- **テスト内容**:
  - 1枚目: 「あ」の札
  - 2枚目: 「い」の札
  - 最後: 「わ」の札
- **期待結果**: インデックス順に出題

#### Test Case 2.2: 札の表示内容

- **目的**: 各札の読み札が正しく表示される
- **テスト内容**:
  - ひらがなテキストの表示
  - 漢字テキストの表示（設定による）
- **期待結果**: 札データと一致する内容が表示

#### Test Case 2.3: 進捗表示

- **目的**: 現在の進捗が正しく表示される
- **テスト内容**:
  - "札: 1/44" の形式で表示
  - 札完了ごとに更新
- **期待結果**: 進捗が正確に反映

### 3. 入力処理テスト

**スイート名**: `練習モード - 入力処理`

#### Test Case 3.1: 正しい入力の処理

- **目的**: 正解入力時に次の札へ進む
- **テスト内容**:
  - 完全一致する入力
  - 次の札への自動遷移
- **期待結果**:
  - completedCardsに追加
  - currentCardIndexが+1
  - 次の札が表示

#### Test Case 3.2: 部分入力の処理

- **目的**: 途中までの入力が正しく判定される
- **テスト内容**:
  - 部分一致の検証
  - リアルタイムフィードバック
- **期待結果**: 正しい部分は緑、間違いは赤表示

#### Test Case 3.3: スキップ機能

- **目的**: スキップボタンで次の札へ移動
- **テスト内容**:
  - スキップボタンクリック
  - キーボードショートカット（→キー）
- **期待結果**:
  - 現在の札をスキップ
  - completedCardsには追加されない

### 4. セッション管理テスト

**スイート名**: `練習モード - セッション管理`

#### Test Case 4.1: 自動保存

- **目的**: 5秒ごとに進捗が保存される
- **モック設定**:
  ```typescript
  vi.useFakeTimers();
  vi.advanceTimersByTime(5000);
  ```
- **テスト内容**: LocalStorageへの保存確認
- **期待結果**: saveSession()が呼ばれる

#### Test Case 4.2: セッションデータ構造

- **目的**: 保存データが正しい形式
- **テスト内容**:
  ```typescript
  const session = {
  	mode: 'practice',
  	currentCardIndex: 5,
  	completedCards: ['a', 'i', 'u', 'e', 'o'],
  	startTime: expect.any(String),
  	totalElapsedTime: expect.any(Number),
  	statistics: {
  		totalKeystrokes: 150,
  		correctKeystrokes: 145,
  		mistakes: 5,
  		wpm: 85,
  		accuracy: 96.7
  	}
  };
  ```
- **期待結果**: 全フィールドが正しく保存

#### Test Case 4.3: セッション復元

- **目的**: resume=trueで中断位置から再開
- **テスト内容**:
  - URL: `/game?mode=practice&resume=true`
  - 保存済みセッションの読み込み
- **期待結果**:
  - 中断した札から表示
  - 統計情報が引き継がれる

#### Test Case 4.4: セッションクリア

- **目的**: ゲーム完了時にセッションが削除される
- **テスト内容**: 44枚目完了後の処理
- **期待結果**: clearSession()が呼ばれる

### 5. 統計記録テスト

**スイート名**: `練習モード - 統計記録`

#### Test Case 5.1: リアルタイム統計更新

- **目的**: 入力のたびに統計が更新される
- **テスト内容**:
  - キーストローク数のカウント
  - 正確率の計算
  - WPMの計算
- **期待結果**: 各指標が正しく計算・表示

#### Test Case 5.2: 札ごとの記録

- **目的**: 各札の成績が記録される
- **テスト内容**:
  ```typescript
  const cardStats = {
  	cardId: 'a',
  	attempts: 1,
  	time: 3500, // ms
  	mistakes: 2,
  	accuracy: 92.3
  };
  ```
- **期待結果**: IndexedDBに保存される

#### Test Case 5.3: 最終結果の集計

- **目的**: 全札完了時の統計が正しい
- **テスト内容**:
  - 平均WPM
  - 全体の正確率
  - 総練習時間
- **期待結果**: サマリー画面に正しく表示

### 6. 一時停止機能テスト

**スイート名**: `練習モード - 一時停止`

#### Test Case 6.1: 一時停止の動作

- **目的**: ゲームが正しく一時停止する
- **テスト内容**:
  - 一時停止ボタンクリック
  - Escキー押下
- **期待結果**:
  - タイマー停止
  - 入力無効化
  - オーバーレイ表示

#### Test Case 6.2: 再開処理

- **目的**: 一時停止から正しく再開する
- **テスト内容**:
  - 再開ボタンクリック
  - Escキー再押下
- **期待結果**:
  - タイマー再開
  - 入力有効化
  - 累積時間の正確性

### 7. 完了処理テスト

**スイート名**: `練習モード - 完了処理`

#### Test Case 7.1: 完了画面の表示

- **目的**: 44枚完了時に結果画面が表示される
- **テスト内容**: 最後の札を正解入力
- **期待結果**:
  - 完了画面への遷移
  - 統計サマリー表示
  - 「もう一度」「メニューへ」ボタン

#### Test Case 7.2: 結果の保存

- **目的**: 練習結果が正しく保存される
- **テスト内容**: IndexedDBへの保存確認
- **期待結果**:
  - gameHistoryテーブルに追加
  - 統計データの更新

### 8. エラーハンドリングテスト

**スイート名**: `練習モード - エラーハンドリング`

#### Test Case 8.1: データ読み込みエラー

- **目的**: 札データ読み込み失敗時の処理
- **モック設定**:
  ```typescript
  vi.mocked(getKarutaCards).mockRejectedValue(new Error());
  ```
- **期待結果**: フォールバックデータで続行

#### Test Case 8.2: 保存エラー

- **目的**: LocalStorage保存失敗時の処理
- **モック設定**:
  ```typescript
  vi.mocked(LocalStorageService.prototype.saveSession).mockRejectedValue(new Error());
  ```
- **期待結果**: 警告表示後、ゲーム続行

#### Test Case 8.3: セッション復元エラー

- **目的**: 破損したセッションデータの処理
- **モック設定**: 不正なJSONデータ
- **期待結果**: 新規セッションとして開始

### 9. パフォーマンステスト

**スイート名**: `練習モード - パフォーマンス`

#### Test Case 9.1: 初期読み込み時間

- **目的**: 500ms以内での初期表示
- **テスト内容**: performance.now()で測定
- **期待結果**: 500ms未満

#### Test Case 9.2: 札切り替え速度

- **目的**: 100ms以内での札切り替え
- **テスト内容**: 正解入力から次札表示まで
- **期待結果**: 100ms未満

#### Test Case 9.3: 入力応答性

- **目的**: 即座の入力反映（< 16ms）
- **テスト内容**: キー入力から画面更新まで
- **期待結果**: 1フレーム以内

### 10. アクセシビリティテスト

**スイート名**: `練習モード - アクセシビリティ`

#### Test Case 10.1: キーボード操作

- **目的**: マウスなしで全操作可能
- **テスト内容**:
  - Tab: フォーカス移動
  - Enter: 確定
  - Esc: 一時停止
  - →: スキップ
- **期待結果**: すべての操作が可能

#### Test Case 10.2: スクリーンリーダー対応

- **目的**: 適切なARIA属性の設定
- **テスト内容**:
  - aria-label
  - aria-live
  - role属性
- **期待結果**: 読み上げ可能

## モックデータ定義

### 札データ（部分）

```typescript
const mockCards = [
	{ id: 'a', hiragana: 'あさまのいぶき かぜもさわやかに' },
	{ id: 'i', hiragana: 'いそべのはまの あきのすなやま' },
	{ id: 'u', hiragana: 'うすいとうげの もみじのまつり' }
	// ... 44枚分
];
```

### セッションデータ

```typescript
const mockSession = {
	mode: 'practice',
	currentCardIndex: 10,
	completedCards: ['a', 'i', 'u', 'e', 'o', 'ka', 'ki', 'ku', 'ke', 'ko'],
	startTime: '2024-01-01T10:00:00Z',
	totalElapsedTime: 300000, // 5分
	statistics: {
		totalKeystrokes: 500,
		correctKeystrokes: 485,
		mistakes: 15,
		wpm: 75,
		accuracy: 97.0
	}
};
```

## テスト実行環境

- **フレームワーク**: Vitest
- **モック**: vi.fn(), vi.spyOn()
- **タイマー**: vi.useFakeTimers()
- **ストレージ**: メモリ内モック
